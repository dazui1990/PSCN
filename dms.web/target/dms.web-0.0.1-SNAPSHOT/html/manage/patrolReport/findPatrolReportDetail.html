<style>
#findPatrolReport tr td{
	text-align: center;
	vertical-align: middle!important;
}
/* 评价项大类 标签样式 */
#findPatrolReport li a{
	margin-bottom: 8px !important;
}
/* 激活样式*/
#findPatrolReport ul > li.active > a{
	font-size: 14px;
   	color: #FFF !important;
	border-color: #3598dc !important;
    background-color: #3598dc !important;
}

/* 整改计划书样式*/
#findPatrolReport #dCorrectList span{
	white-space:pre-wrap !important;
	word-wrap:break-word;
  	word-break:break-all;
}
#findPatrolReport #dCorrectList td{
	vertical-align:middle;
}	
/* 评价项大类 */
#findPatrolReport #dCorrectList td:nth-child(2){
	min-width:100px;
}
/* 评价项项目 */
#findPatrolReport #dCorrectList td:nth-child(3){
	min-width:120px;
}
/* 评价项项目基准 */
#findPatrolReport #dCorrectList td:nth-child(4){
	min-width:140px;
}
/* 建议实施措施 */
#findPatrolReport #dCorrectList td:nth-child(5){
	min-width:180px;
	text-align:left !important;
}
/* 本店实施措施 */
#findPatrolReport #dCorrectList td:nth-child(6){
	min-width:180px;
	text-align:left !important;
}
/* 责任人 */
#findPatrolReport #dCorrectList td:nth-child(7){
	min-width:75px;
}
</style>
<link rel="stylesheet" href="css/comment.css">
<link rel="stylesheet" href="css/style.css">
<script type="text/javascript" src="js/jquery.flexText.js"></script>

<div class="dms-search" id="findPatrolReport">
<div class="panel panel-default">
  <div class="row" style="padding: 20px 5px">
		<div class="col-xs-9">
			<div class="col-xs-3">
				<label class="control-label col-xs-10" id="titleName"></label>
			</div>
			<div class="col-xs-6">
				<label class="control-label col-xs-10" id="titleDate"></label>
			</div>
			<div class="col-xs-3">
					<label class="control-label col-xs-10" id="titleBy"></label>
			</div>
		</div>
		<div class="quert-btn" style="float: right;">
			<a id="btnF" class="btn blue" data-toggle="modal"
				data-url="manage/patrolReport/findReportFile.html" 
				data-beforeShowEvent="true" data-width="modal-lg" >
				<i class="fa fa-paperclip"> 附件查看</i>
			</a>			
			<a  id="btnShare" class="btn blue"  data-toggle="modal"
			 	data-beforeShowEvent="true" data-url="manage/patrolReport/addShareInfo.html"
				data-width="modal-md">
				<i class="fa fa-star-o"> 分享</i>
			</a>		
			<a id="goback" class="btn blue ajaxify" data-goback="page" href="manage/patrolReport/findPatrolReport.html" >
				<i class="fa fa-reply"></i> 返回
			</a>		
	    </div>
	</div>
  <!-- 操作按钮 -->
    <!-- 操作按钮 -->
<!--   <div id="typeMenu" class="row">
	<div class="col-xs-12 col-sm-12 col-md-12 col-lg-12" style="text-align: center;">
	<ul class="nav nav-tabs">
		<li class="col-xs-3 active">
			<a id="btnE" data-toggle="tab" aria-expanded="true">巡回评价表</a>
		</li>
		<li class="col-xs-3">
			<a id="btnNL" data-toggle="tab" aria-expanded="true">N&L评价</a>
		</li>
		<li class="col-xs-3">
			<a id="btnO" data-toggle="tab" aria-expanded="true">其他评价</a>
		</li>
		<li class="col-xs-3">
			<a id="btnC" data-toggle="tab" aria-expanded="true">整改计划书</a>
		</li>
	</ul> -->
  <div class="row">
	<div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
		<div class="col-xs-3" style="text-align: center;"> 
		<a id="btnE" class="btn blue" style="width: 100px">巡回评价表
	    </a>
	    </div>
		<div class="col-xs-3" style="text-align: center;">
		<a id="btnNL" class="btn blue" style="width: 100px">N&L评价
	    </a>
		</div>	    
		<div class="col-xs-3" style="text-align: center;">
		<a id="btnO" class="btn blue" style="width: 100px">其他评价
	    </a>
		</div>
		<div class="col-xs-3" style="text-align: center;">
		<a id="btnC" class="btn blue" style="width: 100px">整改计划书
	    </a>
		</div>
	</div>
  </div>
  <br>
  <form class="form-horizontal">
	<!-- 巡回评价表 --> 
	<div id="evaluate">
		<div class="panel panel-default table-panel">
			<div class="panel-body">
			 	<div class="row">
			 	<div class="col-xs-3" style="text-align: center;">
					<a id="btnER" class="btn blue" style="width: 110px" data-toggle="modal" data-width="modal-lg" 
						data-url="manage/patrolReport/findEvaluateReport.html" data-beforeShowEvent="true">巡回评价报告
	    			</a>
	    		</div>
	    		</div><br>
				<ul id="eItem" class="nav col-xs-12 col-sm-12 col-md-12 col-lg-12">
				</ul>
				<table class="table table-striped table-bordered table-hover table-responsive" id="dEvaluateList"></table>
			</div>
		</div>
	</div>
	<!-- N&L评价表 -->
	<div id="nl">
		<div class="panel panel-default table-panel">
			<div class="panel-body">
				<table class="table table-striped table-bordered table-hover table-responsive" id="dNlList"></table>
			</div>
		</div>
	</div>
	<!-- 其他评价表 -->
	<div id="other">
		<div class="panel panel-default table-panel">
			<div class="panel-body">
				<table class="table table-striped table-bordered table-hover table-responsive" id="dOtherList"></table>
			</div>
		</div>
	</div>
	<!-- 整改计划书 -->
	<div id="correct">
		<div class="panel panel-default table-panel">
			<div class="panel-body">
				<table class="table table-striped table-bordered table-hover table-responsive" id="dCorrectList"></table>
			</div>
		</div>
	</div>	
  </form> 
</div>  
  	<div>
  	 	<input type="hidden" name="isShare" value="{[IS_SHARE]}">
  	 	<input type="hidden" name="isShowBack" value="{[IS_SHOW_BACK]}">
  	</div>
	
	<form class="form-horizontal">
	<!-- 报告说明 -->
	<div id="rMsg" class="commentAll">
		<div class="modal-header">
			<div class="modal-title">报告说明</div>
		</div>
		<div class="comment-show" id="comment-show">
        <div class="comment-show-con clearfix">
	</div>
	</form>
	
</div>
<script type="text/javascript">
$(document).one("onload.dms",function(event,container){
	$("#titleName",container).html("售后运营评价表  -> 巡回评价表");
	$("#titleDate",container).html(showZhDate("计划评价日期",{[EVALUATE_DATE]}));
	$("#titleBy",container).html("评价人 ：" + "{[EVALUATE_BY_NAME]}");
	 
	var evaluateId1 = 0;
	//加载巡店评价表 评价项大类
	dmsCommon.ajaxRestRequest({
		url : dmsCommon.getDmsPath()["manage"]+ "/patrolReport/findItemIdsById/{[EVALUATE_ID]}",
		type : 'GET',
		async : false,
		dataType : 'JSON',
		sucessCallBack : function(data) {
			data.forEach(function(value,index){
				$("#eItem",container).append("<li class='col-xs-3'><a id='eItem"+index+"' name='eItem' data-toggle='tab' class='btn blue btn-outline' onclick='changeEvaluate("+value.bigitemid+");'>"+value.bigitemname+"</a></li>");
				//默认查询第一个
				if(index == 0){
					evaluateId1 = value.bigitemid;
					$("#eItem0",container).click();
				}
			})
			
		}
	});
	
	//巡回评价表
	var evaluateUrl = dmsCommon.getDmsPath()["manage"] + "/patrolReport/findEvaluateDetail/{[EVALUATE_ID]}/"+evaluateId1; 
	new Datatable().initLocale({
		src : "dEvaluateList",
		container : container,
		url : evaluateUrl,
		rowID : "ID",
		autoHeight : false,
		height:480,
		columns : [ 
		    {field : "PROJECT_NAME",title : "评价项项目"},
			{field : "BENCHMARKS_NAME",title : "评价项项目基准"},
			{field : "EVALUATE_STATUS",title : "评价",codeFormat : {type:"dict",codeType:"9203"}},
  		    {field : "URL",title : "照片/视频",formatter:function(value,row,index){
  		    	if(row.FILE_SIZE != null){
	         		return '<input type="hidden" id="billId'+index+'" value="'+row.URL+'">'
		    		+'<a class="btn" name="queryFile" data-beforeShowEvent="true" data-url="manage/patrolReport/findReportFile.html" data-toggle="modal" data-width="modal-lg">查看</a>';
  		    	}else{
  		    		return '';
  		    	}
			}},	 	
			{field : "REMARK",title : "备注"},
			{field : "RULE_NAME",title : "得分规则名称"},
			{field : "WEIGHT_RATIO",title : "权重"},
			{field : "SCORE",title : "得分"}
		],
		 onLoadSuccess: function (data) {
			$("#dEvaluateList a[name='queryFile']",container).on("beforeShow.dms",function(event,returnResult){
				var billId = formatNull($(this).prev().val());
				var billType = 10421010;
				var map={billId:billId,billType:billType};
				$(this).data("pageData",map);
				returnResult.status = true;
			});
			
		    //合并单元格
		    var data = $('#dEvaluateList').bootstrapTable('getData', true);
            mergeCells(data, "", "PROJECT_NAME", 1, $('#dEvaluateList'));
            mergeCells(data, "PROJECT_NAME", "RULE_NAME", 1, $('#dEvaluateList'));
            mergeCells(data, "PROJECT_NAME", "WEIGHT_RATIO", 1, $('#dEvaluateList'));
            mergeCells(data, "PROJECT_NAME", "SCORE", 1, $('#dEvaluateList'));
		}
	});
	
	//N&L评价表
	dmsCommon.ajaxRestRequest({
		url : dmsCommon.getDmsPath()["manage"]+ "/patrolReport/findCountInNlEvaluate/{[AGENDA_ID]}",
		type : 'GET',
		async : false,
		dataType : 'JSON',
		sucessCallBack : function(data) {
			var columns1=[];
			var columns2=[];
			columns1.push({field : "COLUMN1",rowspan: 2,colspan : 1,align : "center"});
			columns1.push({field : "COLUMN2",rowspan: 2,colspan : 1,align : "center"});
			if(data > 0){
				for(var i=1; i<=data; i++){
					columns1.push({field : "CAR_"+i,title : "第"+i+"台",rowspan: 1,colspan : 2,align : "center"});
					columns2.push({field : "CAR_"+i+"_B",title : "开始",align : "center"});
					columns2.push({field : "CAR_"+i+"_E",title : "结束",align : "center"});
				}
			}
		
			new Datatable().initLocale({
				src : "dNlList",
				url : dmsCommon.getDmsPath()["manage"]+ "/patrolReport/findNlEvaluateDetail/{[AGENDA_ID]}",
				container : container,
				autoHeight : false,
				height:480,
				isShowLineNumber : false,
				columns : [columns1,columns2],
				onLoadSuccess : function(){
					//奇数行(XX损失时间) 单元格合并
					for(var index=0;index<=17;index++){
						if(index%2 != 0){
							$("#dNlList tr[data-index="+index+"]",container).css("background-color","#D3D3D3");
							for(var i=1;i<=data;i++){
				  	        	$("#dNlList",container).bootstrapTable('mergeCells',{index:index, field:"CAR_"+i+"_B", colspan: 2, rowspan: 1});   
							}
						}
					}
				}
			});
		}
	});
	
/* 	//N&L评价表
	 new Datatable().initLocale({
		src : "dNlList",
		container : container,
		url : dmsCommon.getDmsPath()["manage"]+ "/patrolReport/findNlEvaluate/{[AGENDA_ID]}",
		autoHeight : false,
		columns : [
			{field : "NL_SURFACE_NAME",title : "评价表名称"},
			{field : "NL_NEWADD_DATE",title : "评价完成时间",formatter:function(value,row,index){
				return formatNull(value)==""?"":formatDate(value,"YYYY-MM-DD HH:mm");
			}},
			{field : "CREATED_BY_NAME",title : "评价人"},
		    {field : "ID",title : "详情", formatter:function(value,row,index){
		    	return '<a id="btnNLD" class="btn ajaxify" title="详情" href="manage/patrolReport/findNlEvaluateDetailF.html"'
				  +'data-beforeShowEvent="true" value='+value+'><i class="fa fa-lg fa-list-alt"></i></a>';
		    }}
		],
		onLoadSuccess: function (data) {
			$("#dNlList #btnNLD",container).on("beforeShow.dms",function(event,returnResult){
				//页面初始化参数传入详情页面用于返回
				var nlId = $(this).attr("value");
				var map= {  NL_ID:nlId,ID:{[ID]},EVALUATE_ID:{[EVALUATE_ID]},AGENDA_ID:{[AGENDA_ID]},
							EVALUATE_NAME:"{[EVALUATE_NAME]}",EVALUATE_DATE:{[EVALUATE_DATE]},
	 						EVALUATE_BY:"{[EVALUATE_BY]}",EVALUATE_BY_NAME:"{[EVALUATE_BY_NAME]}"
					   };
				$(this).data("pageData",map);
				returnResult.status = true; 
			});
		}
	}); */ 
	
	//其他评价表
	 new Datatable().initLocale({
		src : "dOtherList",
		container : container,
		url : dmsCommon.getDmsPath()["manage"]+ "/patrolReport/findOtherEvaluate/{[AGENDA_ID]}",
		autoHeight : false,
		height:480,
		columns : [
			{field : "EVALUATE_NAME",title : "评价表名称"},
			{field : "EVALUATE_DATE",title : "计划评价时间",formatter:function(value,row,index){
				return formatNull(value)==""?"":formatDate(value,"YYYY-MM-DD");
			}},
			{field : "EVALUATE_BY_NAME",title : "评价人"},
		    {field : "ID",title : "详情", formatter:function(value,row,index){
		    	return '<a id="btnOtherD" class="btn ajaxify" title="详情" href="manage/patrolReport/findOtherEvaluateDetailF.html"'
				  +'data-beforeShowEvent="true" value='+value+'><i class="fa fa-lg fa-list-alt"></i></a>';
		    }}
		],
		onLoadSuccess: function (data) {
			$("#dOtherList #btnOtherD",container).on("beforeShow.dms",function(event,returnResult){
				//页面初始化参数传入详情页面用于返回
				var otherId = $(this).attr("value");
				var map= {  OTHER_ID:otherId,ID:{[ID]},EVALUATE_ID:{[EVALUATE_ID]},AGENDA_ID:{[AGENDA_ID]},
							EVALUATE_NAME:"{[EVALUATE_NAME]}",EVALUATE_DATE:{[EVALUATE_DATE]},
					 		EVALUATE_BY:"{[EVALUATE_BY]}",EVALUATE_BY_NAME:"{[EVALUATE_BY_NAME]}"
					 	};
				$(this).data("pageData",map);
				returnResult.status = true; 
			});
		}
	});
	
	
	//整改计划书
	new Datatable().initLocale({
		src : "dCorrectList",
		container : container,
		url : dmsCommon.getDmsPath()["manage"] + "/correctPlan/findCorrectPlanDetail/{[EVALUATE_ID]}",
		autoHeight : false,
		height:480,
		columns : [ 
		    {field : "ITEM_NAME",title : "评价项大类",formatter:function(value,row,index){
				return "<span id='ITEM_NAME"+index+"'>"+formatNull(value)+"</span>";
		    }},
		    {field : "PROJECT_NAME",title : "评价项项目",formatter:function(value,row,index){
		    	return "<span id='PROJECT_NAME"+index+"'>"+formatNull(value)+"</span>";
		    }},
		    {field : "BENCHMARKS_NAME",title : "评价项项目基准",formatter:function(value,row,index){
		    	return "<span id='BENCHMARKS_NAME"+index+"'>"+formatNull(value)+"</span>";
		    }},
			{field : "IMPLEMENT_MEASURE",title : "建议实施措施",formatter:function(value,row,index){
				return "<span id='IMPLEMENT_MEASURE"+index+"'>"+formatNull(value)+"</span>";
		    }},
			{field : "REAL_MEASURE",title : "本店实施措施",formatter:function(value,row,index){
				return "<span id='REAL_MEASURE"+index+"'>"+formatNull(value)+"</span>";
		    }},
			{field : "RESPONSIBLE_BY",title : "责任人",formatter:function(value,row,index){
				return "<span id='RESPONSIBLE_BY"+index+"'>"+formatNull(value)+"</span>";
		    }},
			{field : "PLAN_FINISH_DATE",title : "计划完成时间",formatter:function(value,row,index){
				return formatNull(value)==""?"":formatDate(value,"YYYY-MM-DD");
			}},
			{field : "REAL_FINISH_DATE",title : "实际完成时间",formatter:function(value,row,index){
				return formatNull(value)==""?"":formatDate(value,"YYYY-MM-DD");
			}},
  		    {field : "FILE_ID",title : "附件",formatter:function(value,row,index){
  		         return '<input type="hidden" id="billId'+index+'" value="'+row.ID+'">'
  				    +'<a class="btn" name="queryFile" data-beforeShowEvent="true" data-url="manage/patrolReport/findReportFile.html" data-toggle="modal" data-width="modal-lg">查看</a>';
  			}},	 
  			{field : "AUDIT_DATE",title : "审批日期",formatter:function(value,row,index){
				return formatNull(value)==""?"":formatDate(value,"YYYY-MM-DD");
			}},
			{field : "CLOSE_DATE",title : "关闭日期",formatter:function(value,row,index){
				return formatNull(value)==""?"":formatDate(value,"YYYY-MM-DD");
			}},
			{field : "CORRECT_STATUS",title : "状态",codeFormat : {type : "dict",codeType : "9204"}}
		],
		 onLoadSuccess : function(){
			$("#dCorrectList tbody tr",container).each(function(index,element){
				var correctStatus = $(this).find("td").eq(12).text();
				if(correctStatus == "店端已上传"){
					$(this).css("background-color","#ffff99");
				}
 				//逾期未完成显示为红色
 				//修复非GOOGLE浏览器 无法date(XXXX-XX-XX)格式的日期 
				var planDateStr = $(this).find("td").eq(7).text().replace(new RegExp(/-/gm) ,"/");
				var finishDateStr = $(this).find("td").eq(8).text().replace(new RegExp(/-/gm) ,"/");
				if(finishDateStr!=null && finishDateStr!=""){
					var planDate = new Date(planDateStr);
					var finishDate = new Date(finishDateStr);
					if(finishDate.getTime() > planDate.getTime()){
						$(this).css("background-color","#ff9999");
					}
				}
			});
			
			//查看附件
			$("#dCorrectList a[name='queryFile']",container).on("beforeShow.dms",function(event,returnResult){
				var billId = formatNull($(this).prev().val());
				//整改计划附件
				var billType = 10421002;
				var data={billId:billId,billType:billType};
				$(this).data("pageData",data);
				returnResult.status = true;
			});
			
            //合并单元格
		    var data = $('#dCorrectList').bootstrapTable('getData', true);
            mergeCells(data, "ITEM_NAME", 1, $('#dCorrectList'));
            mergeCells(data, "PROJECT_NAME", 1, $('#dCorrectList'));
		}  
	});
	
	//巡回报告说明
	dmsCommon.ajaxRestRequest({
		url : dmsCommon.getDmsPath()["manage"] + "/patrolReport/findPatrolReportMsg/{[ID]}",
		type : 'GET',
		async : false,
		sucessCallBack : function(data) {
			$('.comment-show',container).html('');
			
			var reg=new RegExp("&lt;br&gt;","g"); //创建正则RegExp对象  
			if(data.first.length>0){
				var reportMsg = data.first[0].reportMsg;
				if($.trim(reportMsg)){
					reportMsg = reportMsg.replace(reg,"\r\n");
				}
				//动态创建评论模块
			 	var fHtml = '<div class="comment-show-con-list '+'reportId-'+data.first[0].reportId+' clearfix"><div class="comment-show-con-list pull-left clearfix"><input type="hidden" name="msgId" value="'+data.first[0].msgId+'"><div class="pl-text clearfix"><a class="comment-size-name">'+data.first[0].byName+' : </a><br> <span class="my-pl-con" style="white-space:pre-wrap;">'+ reportMsg +'</span></div>';
			 	fHtml+='<div class="date-dz"><span class="date-dz-left pull-left comment-time">'+data.first[0].sendTime+'</span>';
			 	//排除自己说的话
			 	if(data.userId[0] != data.first[0].byId){
			 		fHtml+='<div class="date-dz-right pull-right comment-pl-block"><a href="javascript:;" class="date-dz-pl pl-hf hf-con-block pull-left" toId="'+data.first[0].byId+'" toName="'+data.first[0].byName+'">回复</a></div>';
			 	}
			 	fHtml+='</div><div class="hf-list-con"></div><div class="hf-area-con"></div></div></div>';
				$('.comment-show',container).prepend(fHtml);
			}else{
				//没有报告说明隐藏
				$("#rMsg",container).css("display","none");
			}
			
			if(data.next.length>0){
				for(var i=0;i<data.next.length;i++){
					var reportMsg = data.next[i].reportMsg;
						if($.trim(reportMsg)){
							reportMsg = reportMsg.replace(reg,"\r\n");
						}
						var nHtml = '<div class="all-pl-con"><input type="hidden" name="msgId" value="'+data.next[i].msgId+'"><div class="pl-text hfpl-text clearfix"><a href="#" class="comment-size-name">'+data.next[i].byName+' ：&nbsp; </a><span class="my-pl-con" style="white-space:pre-wrap;">'+'<a class="atName">回复@'+data.next[i].toName+'</a></span><br><span class="my-pl-con" style="white-space:pre-wrap;">'+reportMsg+'</span></div><div class="date-dz"><span class="date-dz-left pull-left comment-time">'+data.next[i].sendTime+'</span> <div class="date-dz-right pull-right comment-pl-block">';
					 	if(data.userId[0] != data.next[i].byId){
					 		nHtml += '<a href="javascript:;" class="date-dz-pl pl-hf hf-con-block pull-left" toId="'+data.next[i].byId+'" toName="'+data.next[i].byName+'">回复</a></div>';
					 	}
						nHtml += '</div></div>';
						$('.reportId-'+data.next[i].reportId).find('.hf-list-con').css('display','block').prepend(nHtml);
				}
			}
		}
	});
	
	//弹出回复框
	$('.comment-show',container).on('click','.pl-hf',function(){
		var toId = $(this).attr("toId");
		var toName = $(this).attr("toName");
	    var fhHtml = '<div class="hf-con pull-left"><div class="fhN">回复 @'+toName+'：</div><textarea class="comment-input hf-input" placeholder="" onkeyup="checkLength(this)"></textarea><a class="hf-pl" toId="'+toId+'" toName="'+toName+'">回复</a></div>';
	    if($(this).is('.hf-con-block')){
	    	$('.comment-show',container).find('.hf-area-con').append(fhHtml);
	        $('.pl-hf',container).removeClass('hf-con-block');
	        //$('.content').flexText();
	       	$('.comment-show',container).find('.hf-area-con').find('.hf-con').find('.pre').css('padding','8px 15px');
	       	$('.comment-show',container).find('.hf-area-con').find('.hf-con').find('.hf-input').val('').focus();
	    }else {
	    	$('.pl-hf',container).addClass('hf-con-block');
	        $('.comment-show',container).find('.hf-area-con').find('.hf-con').remove();
	    }
	});
	
	//保存回复内容
	$('.comment-show',container).on('click','.hf-pl',function(){
        //获取输入内容
        var reportId = {[ID]};	
        var reportMsg = $(this).parent('.hf-con').find('.hf-input').val();
        var toId = $(this).attr("toId");
        var toName = $(this).attr("toName");
        if(reportMsg.legnth == 0){
        	dmsCommon.tip({status:"error",msg:"请填写回复内容！"});
        	return;
        }else {   
           dmsCommon.ajaxRestRequest({
				url : dmsCommon.getDmsPath()["manage"] + "/patrolReport/saveMsg",
				type : 'GET',
				async : false,
				dataType : 'json',
				data : {reportId:reportId,reportMsg:reportMsg,toId:toId,toName:toName},
				sucessCallBack : function() {
					dmsCommon.refreshPageByUrl("manage/patrolReport/findPatrolReportDetail.html",container);
				},
				errorCallBack : function() {
		        	dmsCommon.tip({status:"error",msg:"回复失败！"});
				}
			});
        }
    });
	
	//初始显示巡回评价表
	$("#nl",container).css("display","none");
	$("#other",container).css("display","none");
	$("#correct",container).css("display","none");
	
	//事件点击
	$("#btnE",container).click(function(){
		$("#titleName",container).html("售后运营评价表  -> 巡回评价表");
		$("#titleDate",container).html(showZhDate("计划评价日期",{[EVALUATE_DATE]}));
		$("#titleBy",container).html("评价人 ：" + "{[EVALUATE_BY_NAME]}");
		$("#evaluate",container).css("display","block");
		$("#nl",container).css("display","none");
		$("#other",container).css("display","none");
		$("#correct",container).css("display","none");
	});
	$("#btnNL",container).click(function(){
		$("#titleName",container).html("售后运营评价表  -> N&L评价表");
		$("#titleDate",container).html("");
		$("#titleBy",container).html("");
		$("#evaluate",container).css("display","none");
		$("#nl",container).css("display","block");
		$("#other",container).css("display","none");
		$("#correct",container).css("display","none");
	});
	$("#btnO",container).click(function(){
		$("#titleName",container).html("售后运营评价表  -> 其他评价表");
		$("#titleDate",container).html("");
		$("#titleBy",container).html("");
		$("#evaluate",container).css("display","none");
		$("#nl",container).css("display","none");
		$("#other",container).css("display","block");
		$("#correct",container).css("display","none");
	});
	$("#btnC",container).click(function(){
		$("#titleName",container).html("售后运营评价表  -> 整改计划书");
		$("#titleDate",container).html("");
		$("#titleBy",container).html("");
		$("#evaluate",container).css("display","none");
		$("#nl",container).css("display","none");
		$("#other",container).css("display","none");
		$("#correct",container).css("display","block");
	});	
	
	//巡回评价报告
	$("#btnER",container).on("beforeShow.dms",function(event,returnResult){
		 var map = {evaluateId:{[EVALUATE_ID]},evaluateDate:'{[EVALUATE_DATE]}',dealerName:'{[DEALER_SHORTNAME]}'};
		 $(this).data("pageData",map); 
		 returnResult.status = true;
	});
	
	//附件查看
	$("#btnF",container).on("beforeShow.dms",function(event,returnResult){
		 var agendaId = {[AGENDA_ID]};
		 //巡回报告附件
		 var billType = 10421001;
		 var map = {billId:agendaId,billType:billType};
		 $(this).data("pageData",map); 
		 returnResult.status = true;
	});
	
	//分享
	$("#btnShare",container).on("beforeShow.dms",function(event,returnResult){
		 var reportId = {[ID]};
		 var map = {reportId:reportId};
		 $(this).data("pageData",map); 
		 returnResult.status = true;
	});
	
	var isShare = $("input[name='isShare']").val();
	if(isShare == 1){
		$("#btnShare",container).hide();
	}	
	
	var isShowBack = $("input[name='isShowBack']").val();
	if(isShowBack == 1){
		$("#goback",container).hide();
	}
}); 
 
//巡回评价表 标签切换
function changeEvaluate(itemId){
	var evaluateUrl = dmsCommon.getDmsPath()["manage"] + "/patrolReport/findEvaluateDetail/{[EVALUATE_ID]}/"+itemId; 
	$("#dEvaluateList",getElementContext()).bootstrapTable('refresh',{url : evaluateUrl} );
}
 
//显示中文日期
function showZhDate(name,inDate){
	//评价日期格式为年 月 日
	var date = new Date(inDate);
	var year = date.getFullYear();
	var month = date.getMonth()+1;
	var day = date.getDate();
	return name+"： "+year+"年"+month+"月"+day+"日";
} 
 
/**
 * 合并单元格
 * @param data  原始数据
 * @param mFieldName 依赖属性名称
 * @param fieldName 合并属性名称
 * @param colspan   合并列
 * @param target    目标表格对象
 */
function mergeCells(data,mFieldName,fieldName,colspan,target){
	//合并起始行
    var index = 0;
	//合并行数
    var count = 1;
    for(var i = 1 ; i < data.length ; i++){
    	//没有依赖属性  主要列合并
    	if(mFieldName.length == 0){
       		if(data[i-1][fieldName] == data[i][fieldName]){
       			count += 1;
       		}else{
      	        $(target).bootstrapTable('mergeCells',{index:index, field:fieldName, colspan: colspan, rowspan: count});   
      	        index += count;
      	        count = 1;
       		}
       		
       		if(i == data.length-1){
       		    $(target).bootstrapTable('mergeCells',{index:index, field:fieldName, colspan: colspan, rowspan: count});   
       		}
    	}
    	//依赖列合并
    	else{
       		if(data[i-1][fieldName] == data[i][fieldName] && data[i-1][mFieldName] == data[i][mFieldName]){
       			count += 1;
       		}else{
      	        $(target).bootstrapTable('mergeCells',{index:index, field:fieldName, colspan: colspan, rowspan: count});   
      	        index += count;
      	        count = 1;
       		}
       		
       		if(i == data.length-1){
       		    $(target).bootstrapTable('mergeCells',{index:index, field:fieldName, colspan: colspan, rowspan: count});   
       		}    		
    	}
    }
}
//报告说明字数限制1000
function checkLength(a){
	var length = $(a).val().length;
	if(length > 1000){
    	dmsCommon.tip({status:"error",msg:"字数上限为500字！"});
    	var value = $(a).val().substring(0,500);
    	$(a).val(value);
	}
}
</script>